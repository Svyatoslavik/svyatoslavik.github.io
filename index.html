<!DOCTYPE html>

<html>
    <head>
        <title>Удобная Кадастровая Карта Украины</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
        <script src="http://cdn.leafletjs.com/leaflet/v1.0.0-beta.2/leaflet.js"></script>
        <script src="leaflet-bing-layer.js"></script>
        <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=Promise"></script>
        <script src="https://code.jquery.com/jquery-1.12.2.min.js" integrity="sha256-lZFHibXzMHo3GGeehn1hudTAP3Sc0uKXBXAzHX1sjtk=" crossorigin="anonymous"></script>
        <style>
             html, body, .map {
                height: 100%;
                width: 100%;
                margin:0;
                padding:0;
            }
            .map{
                cursor: default;
            }
            .offset-params{
                border: 1px solid #0000ff;
                padding: 5px;
            }
            input[type="number"]{
                width: 50px;
                margin-bottom: 1px;
                font-size: 16px;
            }
            label span{
                width: 10px;
                display: inline-block;
            }
        </style>
    </head>
    <body>
        <div></div>
        <div id="js-map" class="map">
            <div id="js-controll-panel" class="leaflet-control leaflet-bar mycontrol" style="left: 10px; top: 115px; background: #eee; padding: 5px;">
               <input type="checkbox" id="js-satelite-chbx"><label for="js-satelite-chbx"> Спутник</label><br/>
               <input type="checkbox" id="js-kadastr-chbx" checked="checked"><label for="js-kadastr-chbx"> Кадастр</label><br/>
                <input type="checkbox" id="js-offset-chbx"><label for="js-offset-chbx"> Смещение</label>
                <div class="offset-params">
                    <label><span>x:</span><input type="number" id="js-offset-x" value="2"/></label> px<br/>
                    <label><span>y:</span><input type="number" id="js-offset-y" value="-2"/></label> px
                </div>
                
                <div id="distance"></div>
            </div>
        </div>
        <script>
            var degrees2meters = function(lat, lon) {
                    var x = lon * 20037508.34 / 180;
                    var y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180);
                    y = y * 20037508.34 / 180;
                    return {x:x, y:y};
            }
            $(function(){

                var inputOffsetX = $('#js-offset-x');
                var inputOffsetY = $('#js-offset-y');

                if(null !== localStorage.getItem('offset-x')){
                    inputOffsetX.val(parseFloat(localStorage.getItem('offset-x')));
                    inputOffsetY.val(parseFloat(localStorage.getItem('offset-y')));
                }
                   

                var map = L.map('js-map').setView([49.244320, 28.452712], 16);
                var osmLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                });

                L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                });
                
                
                var bingLayer = L.tileLayer.bing('AqwgRuMk4XT0LKK5Mvl4w4IOf1bisyiJMuHOvHU8dGmm7hmPUrFSuOzuE25cQ484');
                
                

                var kadastrLayer = L.tileLayer.wms("http://212.26.144.110/geowebcache/service/wms?tiled=true", {
                    layers: 'kadastr',
                    format: 'image/png',
                    transparent: true,
                    attribution: "Kadastr",
                    zIndex:10,
                    maxNativeZoom: 16,
                });
                kadastrLayer.addTo(map);

                map.on('click', function(e) {
                    
                    var metters = degrees2meters(e.latlng.lat, e.latlng.lng);                   
                    $.ajax({
                        url: 'http://map.land.gov.ua/kadastrova-karta/getobjectinfo',
                        type: 'POST',
                        dataType : "json",
                        data: {
                            x:metters.y.toFixed(7),
                            y:metters.x.toFixed(7),
                            zoom:16,
//                            zoom:Math.min(map.getZoom()+1,16),
                            actLayers:['kadastr']
                        },
                        success: function (data) {
                            showPopup(e.latlng, data);
                        }
                    });

                });
                
                function showBingLayer(){
                    if(!map.hasLayer(bingLayer)){
                        map.addLayer(bingLayer);
                        map.removeLayer(osmLayer);
                    }                    
                }
                function showOSMLayer(){
                    if(!map.hasLayer(osmLayer)){
                        map.addLayer(osmLayer);
                        map.removeLayer(bingLayer);
                    }
                }
                
                function showPopup(latlng, data){
                    if(!data.dilanka) return;
                    var popup = L.popup()
                        .setLatLng(latlng)
                        .setContent(data.dilanka)
                        .openOn(map);
                }
                
                function updateOffset(){
                    var x = parseFloat(inputOffsetX.val());
                    var y = parseFloat(inputOffsetY.val());
                    localStorage.setItem('offset-x', x);
                    localStorage.setItem('offset-y', y);
                    if(!$('#js-offset-chbx').is(':checked')){
                        x=0;
                        y=0;
                    }
                    $(kadastrLayer.getContainer()).css({
                       'margin-top': y+'px',
                       'margin-left':x+'px'
                    });
                }
                $('#js-offset-x, #js-offset-y, #js-offset-chbx').on('change', function(e){
                    e.stopPropagation();
                    updateOffset();
                });
                $('#js-controll-panel').on('click dblclick mousedown', function(e){
                    e.stopPropagation();
                });
                
                $('#js-satelite-chbx, #js-kadastr-chbx').on('change', function(){
                    if($('#js-satelite-chbx').is(':checked')){
                        showBingLayer();
                    }
                    else{
                        showOSMLayer();
                    }
                    
                    if($('#js-kadastr-chbx').is(':checked')){
                        if(!map.hasLayer(kadastrLayer)){
                            map.addLayer(kadastrLayer);
                        }
                    }
                    else{
                        map.removeLayer(kadastrLayer);
                    }
                });
                
                showOSMLayer();
            });
            
       
        
        </script>
    </body>
</html>
