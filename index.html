<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Кадастровая Карта Украины</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
        <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
        <script src="https://code.jquery.com/jquery-1.12.2.min.js" integrity="sha256-lZFHibXzMHo3GGeehn1hudTAP3Sc0uKXBXAzHX1sjtk=" crossorigin="anonymous"></script>
        <style>
            .map{
                width: 100%;
                height: 800px;
                cursor: default;
            }
        </style>
    </head>
    <body>
        <div></div>
        <div id="js-map" class="map">
            
        </div>
        <script>
            var degrees2meters = function(lat, lon) {
                    var x = lon * 20037508.34 / 180;
                    var y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180);
                    y = y * 20037508.34 / 180;
                    return {x:x, y:y};
            }
            $(function(){
                var map = L.map('js-map').setView([49.244320, 28.452712], 16);
                var osmLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                });

                L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                osmLayer.addTo(map);

                var kadastr = L.tileLayer.wms("http://212.26.144.110/geowebcache/service/wms?tiled=true", {
                    layers: 'kadastr',
                    format: 'image/png',
                    transparent: true,
                    attribution: "Kadastr",
                    maxZoom:16
                });
                kadastr.addTo(map);

                map.on('click', function(e) {
                    
                    var metters = degrees2meters(e.latlng.lat, e.latlng.lng);                   
                    $.ajax({
                        url: 'http://map.land.gov.ua/kadastrova-karta/getobjectinfo',
                        type: 'POST',
                        dataType : "json",
                        data: {
                            x:metters.y.toFixed(7),
                            y:metters.x.toFixed(7),
                            zoom:map.getZoom()+1,
                            actLayers:['kadastr']
                        },
                        success: function (data) {
                            showPopup(e.latlng, data);
                        }
                    });

                });
                
                function showPopup(latlng, data){
                    var popup = L.popup()
                        .setLatLng(latlng)
                        .setContent(data.dilanka)
                        .openOn(map);
                }
            });
        
       
        
        </script>
    </body>
</html>
